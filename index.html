<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            Қазақстан топырағының ластану картасы / Карта загрязнения Казахстана
        </title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        />
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="header">
            <h1>
                Қазақстан топырағының ластану картасы / Карта загрязнения почвы
                Казахстана
            </h1>
            <p>Данные за 2024 год</p>
        </div>

        <div class="map-container">
            <div id="loading" class="loading">Загрузка карты...</div>
            <div id="map"></div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
        <script>
            // Инициализация карты
            let map;
            let pollutionData;

            async function initMap() {
                const request = await fetch("data.json");
                pollutionData = await request.json();
                // Создание карты с центром на Казахстане
                map = L.map("map").setView([50, 82], 8);

                // Добавление тайлов OpenStreetMap
                L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                        attribution: "© OpenStreetMap contributors",
                        maxZoom: 18,
                    },
                ).addTo(map);

                // Добавление маркеров
                addPollutionMarkers();

                // Скрытие индикатора загрузки
                document.getElementById("loading").style.display = "none";
            }

            function addPollutionMarkers() {
                pollutionData.forEach((point) => {
                    // Проверка валидности координат
                    if (isValidCoordinate(point.Latitude, point.Longitude)) {
                        // Создание красного маркера
                        const redIcon = L.divIcon({
                            className: "custom-marker",
                            html: `<div style="
                            background-color: #e74c3c;
                            border: 2px solid #c0392b;
                            border-radius: 50%;
                            width: 16px;
                            height: 16px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                        "></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8],
                        });

                        // Создание маркера
                        const marker = L.marker(
                            [point.Latitude, point.Longitude],
                            {
                                icon: redIcon,
                            },
                        ).addTo(map);

                        // Создание содержимого всплывающего окна
                        const popupContent = createPopupContent(point);

                        // Привязка всплывающего окна к маркеру
                        marker.bindPopup(popupContent, {
                            maxWidth: 350,
                            className: "custom-popup",
                        });
                    }
                });
            }

            function createPopupContent(point) {
                return `
                <div class="popup-content">
                    <div class="popup-title">${point.name}</div>
                    <div class="popup-info">
                        <div class="info-item depth-item">
                            <div class="info-label">Глубина</div>
                            <div class="info-value">${point["Depth, cm"]} см</div>
                        </div>
                        <div class="info-item metal-zn">
                            <div class="info-label">Цинк (Zn)</div>
                            <div class="info-value">${point["Zn, 23 mg/kg"]} мг/кг</div>
                        </div>
                        <div class="info-item metal-cu">
                            <div class="info-label">Медь (Cu)</div>
                            <div class="info-value">${point["Cu, 3.0 mg/kg"]} мг/кг</div>
                        </div>
                        <div class="info-item metal-cd">
                            <div class="info-label">Кадмий (Cd)</div>
                            <div class="info-value">${point["Cd, 0.5 mg/kg"]} мг/кг</div>
                        </div>
                        <div class="info-item metal-pb">
                            <div class="info-label">Свинец (Pb)</div>
                            <div class="info-value">${point["Pb, 32 mg/kg"]} мг/кг</div>
                        </div>
                    </div>
                </div>
            `;
            }

            function isValidCoordinate(lat, lng) {
                return (
                    lat >= -90 &&
                    lat <= 90 &&
                    lng >= -180 &&
                    lng <= 180 &&
                    !isNaN(lat) &&
                    !isNaN(lng)
                );
            }

            // Инициализация карты после загрузки страницы
            window.addEventListener("load", initMap);
        </script>
    </body>
</html>
